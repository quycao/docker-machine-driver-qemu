## Docker toolbox with QEMU on Windows

### 1. Requirements
- QEMU 2.9.0+
- Intel HAXM driver
- Install Docker toolbox without Virtualbox

    ```bash
    # Docker and DockerMachine are required. 
    $ DockerToolbox-<version>.exe /COMPONENTS="Docker,DockerMachine"
    ```

- Install Putty, that contain PLINK.EXE, PSCP.EXE for automation ssh and scp, add that folder to Windows Environments Path
- Download alfresco-jlan-source_5_0_0.zip and extract to C:\Program Files\Docker Toolbox\alfresco-jlan
- Download Tiny Core Linux packages below and put them to C:\Program Files\Docker Toolbox\tcz

    http://tinycorelinux.net/10.x/x86_64/tcz/mtd-4.19.10-tinycore64.tcz  
    http://tinycorelinux.net/10.x/x86_64/tcz/libcups2.tcz  
    http://tinycorelinux.net/10.x/x86_64/tcz/popt.tcz  
    http://tinycorelinux.net/10.x/x86_64/tcz/filesystems-4.19.10-tinycore64.tcz  
    http://tinycorelinux.net/10.x/x86_64/tcz/samba-libs.tcz  
    http://tinycorelinux.net/10.x/x86_64/tcz/cifs-utils.tcz

- Set QEMU_LOCATION in Windows Environments

    ```text
    QEMU_LOCATION = C:\Program Files\qemu
    ```

### 2. Prepare docker-machine-driver-qemu
- Download 'docker-machine-driver-qemu.exe' file and put it into C:\Program Files\Docker Toolbox, add that location to Windows Environments Path

### 3. Create VM
- Copy boot2docker.iso file to ~/.docker/machine/cache, it can be found in C:\Program Files\Docker Toolbox
- Create docker-machine VM

    ```bash
    $ docker-machine create --driver qemu --qemu-open-ports 9001,9999 default
    ```

- If get create machine fail, get the qemu start VM command that generated by qemu dirver and run in Command Prompt to see the error detail.

- Test the VM is created

    ```bash
    $ docker-machine ls
    $ docker-machine env default
    ```
  
### 4. Start/Stop/Restart VM

```bash
$ docker-machine start default
$ docker-machine stop default
$ docker-machine restart default
$ docker-machine rm default
```

### 5. Update Docker Toolbox start.sh to work with QEMU and run it
- See file start.sh

### 6. Mount filesytem from host to VM (It is automatically by start.sh now)
- VS Code mount principle  
  You basically need 2 successive mounts:
    - The first one to mount a directory from your host to your system
    - The second to mount the new directory from boot2docker to your container like this:

      * Mount local system on boot2docker

      ```bash
      sudo mount -t vboxsf hostfolder /boot2dockerfolder
      ```

      * Mount boot2docker file on linux container  

      ```bash
      docker run -v /boot2dockerfolder:/root/containerfolder -i -t imagename
      ```

    Then when you ls inside the containerfolder you will see the content of your hostfolder.

- Share host folder on port 1445. Firstly, config share in **_alfresco-jlan/jlanConfig.xml_**
- Run JLAN SMB server

  ```bash
  $ cd alfresco-jlan
  $ runsrv.bat
  ```

- Run Docker Toolbox Quickstart Terminal and wait for it ready
- SSH to QEMU VM

  ```bash
  $ ssh docker@localhost -p<ssh_port>
  pass: tcuser
  ```

- Copy or download and install CIFS/FMB support package, dependencies
  - Copy from host to VM

    ```bash
    $ scp -r -P 50587 /c/Temp/tcz/ docker@localhost:~
    ```

  - Or download from url

    ```bash
    $ wget http://tinycorelinux.net/10.x/x86_64/tcz/mtd-4.19.10-tinycore64.tcz \
          http://tinycorelinux.net/10.x/x86_64/tcz/libcups2.tcz \
          http://tinycorelinux.net/10.x/x86_64/tcz/popt.tcz \
          http://tinycorelinux.net/10.x/x86_64/tcz/filesystems-4.19.10-tinycore64.tcz \
          http://tinycorelinux.net/10.x/x86_64/tcz/samba-libs.tcz \
          http://tinycorelinux.net/10.x/x86_64/tcz/cifs-utils.tcz
    ```

  - Install packages

    ```bash
    $ tce-load -i mtd-4.19.10-tinycore64.tcz filesystems-4.19.10-tinycore64.tcz libcups2.tcz popt.tcz samba-libs.tcz cifs-utils.tcz

    $ tce-status -i | grep package_name
    ```

  - Mount filesystem

    ```bash
    $ sudo mkdir -p /mnt/workspaces

    $ sudo mount -v -t cifs //107.125.111.117/WORKSPACES /mnt/workspaces -o username=sdv,password=samsung@1,port=1445,vers=1.0
    ```

### 7. Import docker image

  ```
  $ cd /some_dir/archive_path/
  $ docker export container_id > archive_container.tar
  $ docker import archive_container.tar image_repo:tag
  ```

### 8. VS Code remote container
- Overwrite the workspace mount volume command in .devcontainer.json

  ```json
  {
    "name": "GoDev",
    "image": "golang:alpine-devtools",
    "settings": {
        "terminal.integrated.shell.linux": "/bin/sh"
    },
    "runArgs": ["--privileged"],
    "appPort": ["9999:9999"],
    "workspaceMount": "src=//mnt/workspaces/reponame,dst=/workspaces/reponame,type=bind,consistency=delegated",
    "extensions": [
        "golang.Go"
    ],
    "remoteEnv": {
        "GOPATH": "/go"
        // "PATH": "${containerEnv:PATH}:/usr/local/go/bin",
        // "MY_REMOTE_VARIABLE2": "${localEnv:SOME_LOCAL_VAR}"
    }
  }
  ```

### 9. AWS NoCredentialProviders error
- When run AWS sdk, it have error: _NoCredentialProviders: no valid providers in chain. Deprecated._
  --> We need to update aws credential in container

  ```bash
  $ mkdir -p ~/.aws
  $ vi ~/.aws/credentials
    [default]
    aws_access_key_id=ABC
    aws_secret_access_key=XYZ
  ```

### 10. System file watchers limit
- When work with node, the project contain many files and if you build, you will get error:

  ```text
  Error: ENOSPC: System limit for number of file watchers reached
  ```

- Run commands below to adjust the limit, note that you have to use __"runArgs": ["--privileged"]__ in devcontainer.json

```bash
# insert the new value into the system config
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p

# check that the new value was applied
cat /proc/sys/fs/inotify/max_user_watches
```

### 11. Reference
- Docker Machine driver QEMU  
  https://github.com/intel-iot-devkit/docker-machine-driver-qemu

- Install Docker Toolbox without Virtualbox  
  https://github.com/docker/toolbox/issues/463

- Install VS Code server offline  
  https://stackoverflow.com/questions/56671520/how-can-i-install-vscode-server-in-linux-offline

- Tiny Core OS check package dependencies  
  http://distro.ibiblio.org/tinycorelinux/3.x/tcz/  
  http://tinycorelinux.net/10.x/x86_64/tcz/cifs-utils.tcz.dep

- Customize boot2docker.iso  
  https://weblogs.com.pk/khurram/archive/2016/07/03/customized-boot2docker-iso-with-cifs.aspx
